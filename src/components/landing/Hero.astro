---
import Text from "@/components/fundations/elements/Text.astro";
import Wrapper from "@/components/fundations/containers/Wrapper.astro";

// Fetch home page data from Payload CMS
const res = await fetch('https://payload-cms-7e43.onrender.com/api/pages?where[slug][equals]=/');
const data = await res.json();
const page = data.docs[0];
const sections = (page && page.sections) || [];

const heroSection = sections.find(section => section.sectionType === "hero");
const aboutSection = sections.find(section => section.sectionType === "about");
const workSection = sections.find(section => section.sectionType === "work");
const nowSection = sections.find(section => section.sectionType === "now");

const heroLines = heroSection?.content?.split('\n') || [];

const processRichText = (content) => {
  if (!content) return [];
  // If content is a string, treat as plain text
  if (typeof content === 'string') {
    return content.split('\n\n').filter(Boolean);
  }
  // If content is a Payload richText object, use .html
  if (content.html) {
    return [content.html];
  }
  return [];
};

const aboutContent = processRichText(aboutSection?.content);
const workContent = processRichText(workSection?.content);
const nowContent = processRichText(nowSection?.content);
---

<script>
  // Intersection Observer for fade-in animations
  const observerOptions = {
    root: null,
    rootMargin: '0px',
    threshold: 0.1
  };

  const observer = new IntersectionObserver((entries) => {
    entries.forEach(entry => {
      if (entry.isIntersecting) {
        entry.target.classList.add('animate-in');
        observer.unobserve(entry.target); // Stop observing once animated
      }
    });
  }, observerOptions);

  // Observe all sections with animation classes
  document.querySelectorAll('.animate-on-scroll').forEach((element) => {
    observer.observe(element);
  });
</script>

<style>
  .animate-on-scroll {
    opacity: 0;
    transform: translateY(20px);
    transition: opacity 0.6s ease-out, transform 0.6s ease-out;
  }

  .animate-in {
    opacity: 1;
    transform: translateY(0);
  }

  .delay-200 { transition-delay: 200ms; }
  .delay-400 { transition-delay: 400ms; }
</style>

<section>
  <Wrapper variant="standard" class="pt-12 lg:py-32 xl:py-54">
    <Text
      tag="h1"
      variant="textLG"
      class="font-medium animate-on-scroll"
      set:html={heroLines.join('<br />')}
    />
  </Wrapper>
  <Wrapper variant="standard" class="py-12">
    <div class="animate-on-scroll">
      <Text
        tag="h1"
        variant="textLG"
        class="font-medium mb-4"
      >
        {aboutSection?.title}
      </Text>
      <div class="border-t dark:border-white/10 border-black/10 pt-2">
        <div class="ml-0 md:ml-12 lg:ml-24">
          {aboutContent.map((paragraph) => (
            <Text
              tag="p"
              variant="textSM"
              class="2xl:text-base mt-4"
              set:html={paragraph}
            />
          ))}
        </div>
      </div>
    </div>

    <div class="animate-on-scroll delay-200 mt-36">
      <Text
        tag="h1"
        variant="textLG"
        class="font-medium mb-4"
      >
        {workSection?.title}
      </Text>
      <div class="border-t dark:border-white/10 border-black/10 pt-2">
        <div class="ml-0 md:ml-12 lg:ml-24">
          {workContent.map((paragraph) => (
            <Text
              tag="p"
              variant="textSM"
              class="2xl:text-base mt-4"
              set:html={paragraph}
            />
          ))}
        </div>
      </div>
    </div>

    <div class="animate-on-scroll delay-400 mt-36">
      <Text
        tag="h1"
        variant="textLG"
        class="font-medium mb-4"
      >
        {nowSection?.title}
      </Text>
      <div class="border-t dark:border-white/10 border-black/10 pt-2">
        <div class="ml-0 md:ml-12 lg:ml-24">
          {nowContent.map((paragraph) => (
            <Text
              tag="p"
              variant="textSM"
              class="2xl:text-base mt-4"
              set:html={paragraph}
            />
          ))}
        </div>
      </div>
    </div>
  </Wrapper>
</section>
